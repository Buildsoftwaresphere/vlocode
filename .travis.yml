dist: trusty

language: node_js
node_js:
  - "10"

addons:
  apt:
    packages:
      - libsecret-1-dev
  sonarcloud:
    organization: $SONAR_ORG
    token:
      secure: $SONAR_TOKEN

env:
  global:
    - TEST_RESULTS_FILE=test-results.xml

before_install:
  - export DISPLAY=':99.0'
  - /usr/bin/Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

install:
  - npm install

script:
  - npm run build:debug
  - npm test  
  - npm run lint -- -o tslint-report.json --format json
  - sonar-scanner

before_deploy:
  - export PACKAGE_VERSION=$(node -p "require('./package.json').version")
  - npm run package

deploy:
  - provider: releases
    api_key: $GITHUB_TOKEN
    file_glob: true
    file: "*.vsix"
    skip_cleanup: true
    name: "Version $PACKAGE_VERSION"
    on:
      tags: true
  - provider: script  
    script: npm run publish -- -p $VSCE_TOKEN --packagePath *.vsix
    skip_cleanup: true
    on:
      tags: true